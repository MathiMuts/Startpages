{% extends "modules/_base.html" %}
{% load i18n static socialaccount %}

{% block title %}Manage Connections{% endblock title %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] px-4 py-12">
    
    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-neutral-200 dark:border-gray-700 overflow-hidden">
        
        <!-- Header -->
        <div class="px-8 py-6 bg-neutral-50 dark:bg-gray-900/50 border-b border-neutral-200 dark:border-gray-700 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-neutral-800 dark:text-white">Linked Accounts</h2>
                <p class="text-sm text-neutral-500 dark:text-gray-400 mt-1">
                    Manage your third-party connections.
                </p>
            </div>
            <a href="{% url 'startpages:profile' %}?tab=personal" class="text-sm text-primary-600 hover:underline">
                &larr; Back to Profile
            </a>
        </div>

        <div class="p-8">
            
            {% if form.non_field_errors %}
            <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 rounded-lg text-sm">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- 1. List of Connected Accounts -->
            {% if form.accounts %}
            <form method="post" action="{% url 'socialaccount_connections' %}" id="social_form">
                {% csrf_token %}
                
                <div class="space-y-3 mb-6">
                    {% for base_account in form.accounts %}
                    <label class="flex items-center justify-between p-4 rounded-lg border cursor-pointer transition-all social-row
                                  border-neutral-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-gray-500 bg-white dark:bg-gray-800">
                        
                        <div class="flex items-center gap-4">
                            <!-- Radio Input (Allauth requires name='account') -->
                            <input type="radio" name="account" 
                                   value="{{ base_account.id }}" 
                                   {% if forloop.first %}checked{% endif %}
                                   onchange="updateSelection(this)"
                                   class="account-radio w-5 h-5 text-primary-600 border-gray-300 focus:ring-primary-500">
                            
                            <div class="flex items-center gap-4">
                                <!-- Icon Logic -->
                                {% if base_account.provider == 'google' %}
                                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                                {% else %}
                                    <div class="w-6 h-6 rounded-full bg-neutral-200 dark:bg-gray-600 flex items-center justify-center text-xs font-bold text-neutral-500 uppercase">{{ base_account.provider|slice:":1" }}</div>
                                {% endif %}

                                <div>
                                    <span class="block font-medium text-neutral-900 dark:text-white break-all">
                                        {{ base_account }}
                                    </span>
                                    <div class="flex gap-2 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-300 capitalize">
                                            {{ base_account.provider }} Connected
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>

                <!-- HOLD TO REMOVE BUTTON -->
                <div class="flex justify-end border-t border-neutral-200 dark:border-gray-700 pt-4">
                    <button type="button" id="btn-remove-account"
                            class="relative overflow-hidden group select-none touch-none
                                   w-40 px-4 py-2 rounded-lg text-sm font-bold transition-all
                                   bg-red-50 text-red-600 border border-red-200 
                                   hover:border-red-300 dark:bg-red-900/20 dark:border-red-900 dark:text-red-400"
                            style="-webkit-tap-highlight-color: transparent;">
                        
                        <!-- Fill Animation -->
                        <div id="btn-remove-account-fill" 
                             class="absolute inset-y-0 left-0 bg-red-500 dark:bg-red-600 w-0 opacity-20 group-active:opacity-100 pointer-events-none">
                        </div>

                        <!-- Text -->
                        <span id="btn-remove-account-text" class="relative z-10 block pointer-events-none whitespace-nowrap">
                            Remove
                        </span>
                    </button>
                </div>
            </form>

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-8 border-b border-neutral-200 dark:border-gray-700">
                <p class="text-neutral-500 dark:text-gray-400">You haven't connected any social accounts yet.</p>
            </div>
            {% endif %}

            <!-- 2. Add New Connection -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-neutral-800 dark:text-white mb-4">Connect New Account</h3>
                
                <div class="flex flex-wrap gap-3">
                    {% get_providers as socialaccount_providers %}
                    {% for provider in socialaccount_providers %}
                    <a href="{% provider_login_url provider.id process='connect' scope=scope auth_params=auth_params %}" 
                       class="flex items-center gap-3 px-6 py-2.5 bg-white dark:bg-gray-700 border border-neutral-300 dark:border-gray-600 hover:bg-neutral-50 dark:hover:bg-gray-600 text-neutral-700 dark:text-white font-bold rounded-lg transition-colors cursor-pointer w-full justify-center">
                        {% if provider.id == 'google' %}
                            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                        {% endif %}
                        Connect {{ provider.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        initDeleteLogic();
        
        // Initialize selection styling (Blue highlight on load)
        const checked = document.querySelector('.account-radio:checked');
        if(checked) updateSelection(checked);
    });

    // Handle Visual Selection (Blue Border)
    function updateSelection(radio) {
        document.querySelectorAll('.social-row').forEach(row => {
            row.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'dark:border-primary-500');
            row.classList.add('border-neutral-200', 'dark:border-gray-700', 'bg-white', 'dark:bg-gray-800');
        });
        
        const row = radio.closest('label');
        row.classList.remove('border-neutral-200', 'dark:border-gray-700', 'bg-white', 'dark:bg-gray-800');
        row.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'dark:border-primary-500');
    }

    // --- HOLD TO DELETE LOGIC ---
    let deleteTimer = null;
    let isReady = false;
    const HOLD_DURATION = 1500; 

    function initDeleteLogic() {
        const btn = document.getElementById('btn-remove-account');
        if(!btn) return;
        
        btn.addEventListener('mousedown', handleStart);
        btn.addEventListener('mouseup', handleEnd);
        btn.addEventListener('mouseleave', handleCancel);
        
        // Touch support
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e); });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); handleEnd(e); });
    }

    function handleStart(e) {
        // Only allow left click (button 0) or touch
        if (e.button !== 0 && e.type !== 'touchstart') return; 

        const fill = document.getElementById('btn-remove-account-fill');
        const text = document.getElementById('btn-remove-account-text');

        isReady = false;
        text.innerText = "Hold...";
        text.classList.add('text-red-700', 'dark:text-white');

        // Start filling the bar
        fill.style.transition = `width ${HOLD_DURATION}ms linear`;
        fill.style.width = '100%';
        fill.classList.remove('opacity-20'); 
        fill.classList.add('opacity-100');

        deleteTimer = setTimeout(() => {
            isReady = true;
            text.innerText = "Release to Remove!";
            document.getElementById('btn-remove-account').classList.add('scale-105');
        }, HOLD_DURATION);
    }

    function handleEnd(e) {
        if (isReady) {
            // Submit the form
            document.getElementById('social_form').submit();
        } else {
            handleCancel();
        }
    }

    function handleCancel() {
        clearTimeout(deleteTimer);
        isReady = false;
        
        const btn = document.getElementById('btn-remove-account');
        const fill = document.getElementById('btn-remove-account-fill');
        const text = document.getElementById('btn-remove-account-text');

        // Reset the animation
        if (fill) {
            fill.style.transition = 'width 0.2s ease-out';
            fill.style.width = '0%';
            fill.classList.remove('opacity-100');
            fill.classList.add('opacity-20');
        }

        // Reset text
        if (text) {
            text.innerText = "Remove";
            text.classList.remove('text-red-700', 'dark:text-white');
        }
        
        // Reset scale
        if(btn) btn.classList.remove('scale-105');
    }
</script>
{% endblock %}