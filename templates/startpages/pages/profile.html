{% extends "../../modules/_base.html" %}
{% load static %}

{% block title %}Profile Settings{% endblock title %}

{% block content %}
<div class="container mx-auto px-4 py-12 min-h-screen">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col md:flex-row border border-neutral-200 dark:border-gray-700">
        
        <!-- SIDEBAR -->
        <aside class="w-full md:w-64 bg-neutral-50 dark:bg-gray-900/50 border-r border-neutral-200 dark:border-gray-700 p-6 flex flex-col gap-6">
            
            <!-- User Short Info -->
            <div class="text-center mb-4">
                <div class="w-20 h-20 mx-auto rounded-full overflow-hidden mb-3 border-4 border-white dark:border-gray-700 shadow-sm">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full bg-primary-500 flex items-center justify-center text-white text-2xl font-bold uppercase">
                            {{ user.username|slice:":2" }}
                        </div>
                    {% endif %}
                </div>
                <h2 class="text-lg font-bold text-neutral-800 dark:text-white">{{ user.username }}</h2>
                <p class="text-sm text-neutral-500 dark:text-gray-400">Member</p>
            </div>

            <!-- Navigation -->
            <nav class="flex flex-col gap-2">
                <button onclick="switchTab('personal')" id="tab-btn-personal" class="tab-btn cursor-pointer text-left px-4 py-2 rounded-lg font-medium transition-colors text-neutral-600 dark:text-gray-300 hover:bg-neutral-200 dark:hover:bg-gray-800">
                    Personal Info
                </button>
                <button onclick="switchTab('startpages')" id="tab-btn-startpages" class="tab-btn cursor-pointer text-left px-4 py-2 rounded-lg font-medium transition-colors text-neutral-600 dark:text-gray-300 hover:bg-neutral-200 dark:hover:bg-gray-800">
                    My Startpages
                </button>
                <button onclick="switchTab('customization')" id="tab-btn-customization" class="tab-btn cursor-pointer text-left px-4 py-2 rounded-lg font-medium transition-colors text-neutral-600 dark:text-gray-300 hover:bg-neutral-200 dark:hover:bg-gray-800">
                    Customization
                </button>
                
                <hr class="border-neutral-200 dark:border-gray-700 my-2">
                
                <a href="/" class="text-left px-4 py-2 rounded-lg font-medium transition-colors text-primary-600 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/20">
                    &larr; Back to Startpage
                </a>
                
                <form action="{% url 'logout' %}" method="post" class="w-full">
                    {% csrf_token %}
                    <button type="submit" class="w-full text-left px-4 py-2 rounded-lg font-medium transition-colors text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Sign Out
                    </button>
                </form>
            </nav>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 p-8 md:p-12 overflow-y-auto">
            
            <!-- TAB: Personal Info -->
            <div id="tab-personal" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-bold text-neutral-800 dark:text-white mb-6">Personal Information</h2>
                
                <form action="{% url 'startpages:update_personal_info' %}" method="POST" enctype="multipart/form-data" class="space-y-6 max-w-lg">
                    {% csrf_token %}
                    
                    <!-- Username (Read Only) -->
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 dark:text-gray-300 mb-1">Username</label>
                        <input type="text" value="{{ user.username }}" disabled
                               class="w-full px-4 py-2 rounded-lg bg-neutral-100 dark:bg-gray-900 border border-neutral-300 dark:border-gray-600 text-neutral-500 cursor-not-allowed">
                        <p class="text-xs text-neutral-400 mt-1">Username cannot be changed.</p>
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 dark:text-gray-300 mb-1">Email Address</label>
                        <input type="email" name="email" value="{{ user.email }}"
                               class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-neutral-300 dark:border-gray-600 text-neutral-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>

                    <!-- Profile Picture -->
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 dark:text-gray-300 mb-1">Profile Picture</label>
                        <input type="file" name="avatar" accept="image/*"
                               class="block w-full text-sm text-neutral-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-primary-50 file:text-primary-700
                                      hover:file:bg-primary-100 dark:hover:file:bg-primary-800 dark:file:bg-primary-900 dark:file:text-primary-300 cursor-pointer">
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg transition-colors cursor-pointer">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>

            <!-- TAB: My Startpages -->
            <div id="tab-startpages" class="tab-content hidden animate-fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-neutral-800 dark:text-white">My Startpages</h2>
                    
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <!-- Import Button -->
                        <button onclick="openImportModal()" class="bg-neutral-200 dark:bg-gray-700 hover:bg-neutral-300 dark:hover:bg-gray-600 text-neutral-800 dark:text-white text-sm font-bold px-3 py-1.5 rounded-md transition-colors flex items-center gap-1 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Import
                        </button>

                        <!-- Create New Form (Inline) -->
                        <form action="{% url 'startpages:create_startpage' %}" method="POST" class="flex gap-2 flex-1 sm:flex-none">
                            {% csrf_token %}
                            <input type="text" name="title" placeholder="New page title..." required
                                   class="px-3 py-1.5 rounded-md border border-neutral-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm dark:text-white w-full sm:w-40">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold px-3 py-1.5 rounded-md transition-colors cursor-pointer">
                                Create
                            </button>
                        </form>
                    </div>
                </div>

                <div class="grid gap-4">
                    {% for page in startpages %}
                    <!-- Startpage Item: Click to Edit -->
                    <button 
                        type="button"
                        onclick="openPageEditModal(this)"
                        data-id="{{ page.id }}"
                        data-title="{{ page.title }}"
                        data-default="{{ page.is_default|yesno:'true,false' }}"
                        data-slug="{{ page.slug }}"
                        class="w-full group text-left flex items-center justify-between p-4 bg-neutral-50 hover:bg-white dark:bg-gray-900/50 dark:hover:bg-gray-800 rounded-xl border {% if page.is_default %}border-emerald-500 ring-1 ring-emerald-500{% else %}border-neutral-200 dark:border-neutral-700 hover:border-primary-400 dark:hover:border-primary-500{% endif %} transition-all cursor-pointer shadow-sm hover:shadow-md"
                    >
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-lg transition-colors {% if page.is_default %}bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30{% else %}bg-neutral-200 dark:bg-gray-800 text-neutral-500 group-hover:bg-primary-100 dark:group-hover:bg-primary-900/50 group-hover:text-primary-600 dark:group-hover:text-primary-400{% endif %}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-neutral-800 dark:text-white text-lg">{{ page.title }}</h3>
                                <!-- Stop propagation on the link -->
                                <object class="text-xs text-primary-500 hover:underline">
                                    <a href="{% url 'startpages:detail' user.username page.slug %}" target="_blank" onclick="event.stopPropagation()">
                                        /{{ user.username }}/{{ page.slug }}
                                    </a>
                                </object>
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            {% if page.is_default %}
                                <span class="text-xs font-bold text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400 px-2 py-1 rounded-full">Default</span>
                            {% endif %}
                            <span class="opacity-0 group-hover:opacity-100 text-neutral-400 transition-opacity">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </span>
                        </div>
                    </button>
                    {% empty %}
                    <div class="text-center py-10 text-neutral-500">
                        You don't have any startpages yet. Create one above!
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- TAB: Customization -->
            <div id="tab-customization" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-bold text-neutral-800 dark:text-white mb-6">Customization</h2>
                
                <div class="space-y-6">
                    <!-- Theme Toggle Section -->
                    <div class="flex items-center justify-between p-4 bg-neutral-50 dark:bg-gray-900/50 rounded-xl border border-neutral-200 dark:border-gray-700">
                        <div>
                            <h3 class="font-bold text-neutral-800 dark:text-white">App Theme</h3>
                            <p class="text-sm text-neutral-500">Toggle between Light and Dark mode.</p>
                        </div>
                        
                        <button id="profile-dark-mode-toggle" type="button" class="relative inline-flex h-8 w-14 shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-neutral-200 dark:bg-primary-600 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2">
                            <span class="sr-only">Use setting</span>
                            <span aria-hidden="true" class="pointer-events-none flex h-7 w-7 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0 dark:translate-x-6 flex items-center justify-center">
                                <svg class="w-4 h-4 text-amber-500 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                <svg class="w-4 h-4 text-primary-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            </span>
                        </button>
                    </div>

                    <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm">
                        More customization options coming soon!
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- 1. EDIT PAGE MODAL -->
<div id="page-edit-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closePageEditModal()"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg bg-white dark:bg-gray-800 border-t-4 border-primary-500 dark:border-primary-400">
                
                <div class="px-8 py-8 sm:p-10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold leading-6 text-gray-900 dark:text-white">Edit Startpage</h3>
                        <button type="button" onclick="closePageEditModal()" class="cursor-pointer text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <form id="page-edit-form" method="POST" action="">
                        {% csrf_token %}
                        <div class="space-y-4">
                            <!-- Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Page Title</label>
                                <input type="text" id="edit-page-title" name="title" required
                                       class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 py-3 px-4 sm:text-sm">
                            </div>

                            <!-- Set Default -->
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="edit-page-default" name="is_default" class="h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                                <label for="edit-page-default" class="text-sm font-medium text-gray-700 dark:text-gray-300">Set as Default Page</label>
                            </div>

                            <!-- Export Button (Action Link) -->
                             <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Export</label>
                                <a id="edit-page-export-btn" href="#" target="_blank" class="flex w-full items-center justify-center gap-2 rounded-lg border border-neutral-300 dark:border-gray-600 bg-neutral-100 dark:bg-gray-700 px-3 py-2 text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-neutral-200 dark:hover:bg-neutral-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    Export JSON
                                </a>
                            </div>
                        </div>

                        <!-- Buttons Grid -->
                        <div class="mt-8 grid grid-cols-2 gap-3 sm:grid-flow-row-dense">
                            <!-- Save Button (Right Side) -->
                            <button type="submit" class="col-span-1 inline-flex w-full justify-center rounded-lg bg-primary-600 px-3 py-3 text-sm font-bold text-white shadow-sm hover:bg-primary-500 sm:col-start-2 cursor-pointer">
                                Save
                            </button>
                            
                            <!-- Hold to Delete Button -->
                            <button type="button" id="btn-delete-page"
                                    class="col-span-1 relative w-full justify-center items-center rounded-lg overflow-hidden
                                    bg-red-50 dark:bg-red-900/20 text-sm font-semibold text-red-600 dark:text-red-400 
                                    border border-transparent hover:border-red-200 dark:hover:border-red-800
                                    transition-all sm:col-start-1 cursor-pointer select-none group touch-none"
                                    style="-webkit-tap-highlight-color: transparent;">
                                
                                <div id="btn-delete-page-fill" 
                                     class="absolute inset-y-0 left-0 bg-red-500 dark:bg-red-600 w-0 opacity-20 group-active:opacity-100 pointer-events-none">
                                </div>

                                <span id="btn-delete-page-text" class="relative z-10 py-3 px-3 block w-full pointer-events-none">
                                    Delete
                                </span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Hidden Delete Form (submitted by hold button) -->
                    <form id="page-delete-form" method="POST" action="">
                        {% csrf_token %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2. IMPORT PAGE MODAL -->
<div id="page-import-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeImportModal()"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg bg-white dark:bg-gray-800 border-t-4 border-emerald-500">
                
                <div class="px-8 py-8 sm:p-10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold leading-6 text-gray-900 dark:text-white">Import Startpage</h3>
                        <button type="button" onclick="closeImportModal()" class="cursor-pointer text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <form action="{% url 'startpages:import_startpage' %}" method="POST">
                        {% csrf_token %}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                                    Paste JSON Content
                                </label>
                                <textarea name="json_data" rows="8" required
                                    class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-white font-mono text-xs shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3"
                                    placeholder='{ "title": "My Page", "sections": [...] }'></textarea>
                                <p class="text-xs text-neutral-500 dark:text-gray-400 mt-1">Paste the content of a previously exported startpage JSON file.</p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button type="submit" class="w-full inline-flex justify-center rounded-lg bg-emerald-600 px-3 py-3 text-sm font-bold text-white shadow-sm hover:bg-emerald-500 cursor-pointer">
                                Import Startpage
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- TAB LOGIC ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('bg-primary-100', 'text-primary-700', 'dark:bg-primary-900/50', 'dark:text-primary-300');
            el.classList.add('text-neutral-600', 'dark:text-gray-300');
        });

        const content = document.getElementById('tab-' + tabName);
        const btn = document.getElementById('tab-btn-' + tabName);
        
        if(content) content.classList.remove('hidden');
        if(btn) {
            btn.classList.remove('text-neutral-600', 'dark:text-gray-300');
            btn.classList.add('bg-primary-100', 'text-primary-700', 'dark:bg-primary-900/50', 'dark:text-primary-300');
        }

        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);
    }

    // --- MODAL LOGIC ---
    
    // Import Modal
    function openImportModal() {
        document.getElementById('page-import-modal').classList.remove('hidden');
    }
    
    function closeImportModal() {
        document.getElementById('page-import-modal').classList.add('hidden');
    }

    // Edit Modal
    function openPageEditModal(button) {
        const id = button.getAttribute('data-id');
        const title = button.getAttribute('data-title');
        const isDefault = button.getAttribute('data-default') === 'true';
        
        // Populate fields
        document.getElementById('edit-page-title').value = title;
        document.getElementById('edit-page-default').checked = isDefault;
        
        // Update Action URLs
        document.getElementById('page-edit-form').action = `/profile/page/${id}/edit/`;
        document.getElementById('page-delete-form').action = `/profile/page/${id}/delete/`;
        document.getElementById('edit-page-export-btn').href = `/profile/page/${id}/export/`;
        
        // Show modal
        document.getElementById('page-edit-modal').classList.remove('hidden');
    }

    function closePageEditModal() {
        document.getElementById('page-edit-modal').classList.add('hidden');
        resetPageDeleteButton(); // Reset any active hold animation
    }

    // --- HOLD TO DELETE LOGIC (Re-implemented for Profile Page) ---
    let pageDeleteTimer = null;
    let isPageDeleteReady = false;
    const PAGE_HOLD_DURATION = 5000; 

    function initPageDeleteLogic() {
        const btn = document.getElementById('btn-delete-page');
        if(!btn) return;
        
        btn.addEventListener('mousedown', handlePageHoldStart);
        btn.addEventListener('mouseup', handlePageHoldEnd);
        btn.addEventListener('mouseleave', handlePageHoldCancel);
        
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); handlePageHoldStart(e); });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); handlePageHoldEnd(e); });
    }

    function handlePageHoldStart(e) {
        if (e.button !== 0 && e.type !== 'touchstart') return; 

        const btn = document.getElementById('btn-delete-page');
        const fill = document.getElementById('btn-delete-page-fill');
        const text = document.getElementById('btn-delete-page-text');

        isPageDeleteReady = false;
        
        text.innerText = "Hold...";
        text.classList.add('text-red-700', 'dark:text-white');

        fill.style.transition = `width ${PAGE_HOLD_DURATION}ms linear`;
        fill.style.width = '100%';
        fill.classList.remove('opacity-20'); 
        fill.classList.add('opacity-100');

        pageDeleteTimer = setTimeout(() => {
            isPageDeleteReady = true;
            text.innerText = "Delete!";
            btn.classList.add('scale-105');
        }, PAGE_HOLD_DURATION);
    }

    function handlePageHoldEnd(e) {
        if (isPageDeleteReady) {
            document.getElementById('page-delete-form').submit();
        } else {
            handlePageHoldCancel();
        }
    }

    function handlePageHoldCancel() {
        clearTimeout(pageDeleteTimer);
        isPageDeleteReady = false;
        resetPageDeleteButton();
    }

    function resetPageDeleteButton() {
        const btn = document.getElementById('btn-delete-page');
        const fill = document.getElementById('btn-delete-page-fill');
        const text = document.getElementById('btn-delete-page-text');

        clearTimeout(pageDeleteTimer);

        if (fill) {
            fill.style.transition = 'width 0.2s ease-out';
            fill.style.width = '0%';
            fill.classList.remove('opacity-100');
            fill.classList.add('opacity-20');
        }

        if (text) {
            text.innerText = "Delete";
            text.classList.remove('text-red-700', 'dark:text-white');
        }
        
        if (btn) btn.classList.remove('scale-105');
    }


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab') || 'personal';
        switchTab(tab);
        
        initPageDeleteLogic();

        // Dark Mode
        const profileToggle = document.getElementById("profile-dark-mode-toggle");
        const htmlEl = document.documentElement;

        if (profileToggle) {
            profileToggle.addEventListener("click", () => {
                if (htmlEl.classList.contains('dark')) {
                    htmlEl.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    profileToggle.querySelector('span[aria-hidden="true"]').classList.remove('translate-x-6');
                    profileToggle.querySelector('span[aria-hidden="true"]').classList.add('translate-x-0');
                } else {
                    htmlEl.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    profileToggle.querySelector('span[aria-hidden="true"]').classList.remove('translate-x-0');
                    profileToggle.querySelector('span[aria-hidden="true"]').classList.add('translate-x-6');
                }
            });

            if (htmlEl.classList.contains('dark')) {
                profileToggle.querySelector('span[aria-hidden="true"]').classList.remove('translate-x-0');
                profileToggle.querySelector('span[aria-hidden="true"]').classList.add('translate-x-6');
            }
        }
        
        // Close modals on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                closePageEditModal();
                closeImportModal();
            }
        });
    });
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}