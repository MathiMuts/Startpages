{% extends "../../modules/_base.html" %}
{% load static %}

{% block title %}Startpage{% endblock title %}
{% block content %}

<!-- Main Background with Gradient -->
<div class="h-screen w-full overflow-y-scroll snap-y snap-mandatory scroll-smooth" 
     id="main-scroll-container">

    <!-- Screen 1: Search & Preview Row (Snap Center) -->
    <div class="snap-start min-h-screen flex flex-col justify-center items-center w-full relative py-12">
        
        <!-- Search Bar Container -->
        <div class="w-full max-w-2xl px-4 z-10 mb-52 mt-60">
            {% include "../../components/_search-bar.html" %}
        </div>

        <!-- Preview Row -->
        <div class="w-full px-4 mb-4"> 
             <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 
                        w-72 sm:w-152 md:w-232 lg:w-312 xl:w-392
                        gap-8 mx-auto p-4">
                {% for sec in sections|slice:":5" %}
                    {% include "../../components/_section.html" with section=sec is_preview=True %}
                {% endfor %}
            </div>
        </div>

        <!-- Scroll Indicator -->
        <div class="text-center text-primary-400 dark:text-primary-600 animate-bounce cursor-pointer mt-auto opacity-70 hover:opacity-100 transition-opacity" 
             onclick="document.getElementById('sections-grid').scrollIntoView({behavior: 'smooth'})">
            <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>
    </div>

    <!-- Screen 2: All Sections Grid (Snap Start) -->
    <div id="sections-grid" class="snap-start min-h-screen pt-24 pb-24">
        
        <div class="text-center mb-10">
            <span id="mode-indicator" class="px-4 py-2 rounded-full bg-white/50 dark:bg-black/30 backdrop-blur-sm text-sm font-semibold text-primary-600 dark:text-primary-300 shadow-sm border border-primary-100 dark:border-primary-900/50">
                Hold any item to Edit
            </span>
        </div>

        <div id="grid-container" 
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 
                    w-72 sm:w-152 md:w-232 lg:w-312 xl:w-392
                    gap-8 mx-auto pb-32">
            
            {% for sec in sections %}
                {% include "../../components/_section.html" with section=sec %}
            {% endfor %}

            <!-- Add Section Button -->
            <button onclick="openAddSectionModal()"
                    class="{% if not sections %}flex{% else %}hidden edit-mode-visible{% endif %}
                        h-[30rem] w-full cursor-pointer
                        add-section-btn 
                        flex-col justify-center items-center gap-4
                        rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700
                        bg-white/50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800
                        text-gray-400 hover:text-primary-500 dark:text-gray-500 dark:hover:text-primary-400
                        hover:border-primary-400 dark:hover:border-primary-500
                        transition-colors duration-300 group">
                
                <div class="p-4 rounded-full bg-gray-100 dark:bg-gray-700 group-hover:bg-primary-50 dark:group-hover:bg-primary-900/30 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <span class="font-bold text-lg">Add Section</span>
            </button>
        </div>
    </div>

</div>

{% include "../../components/_edit-modal.html" %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="{% static 'js/startpage_logic.js' %}"></script>

<script>
  function openAllLinksInSection(triggerElement) {
    const section = triggerElement.closest('section');
    if (section) {
      const linksToOpen = section.querySelectorAll('.section-links a');
      linksToOpen.forEach(link => {
        if (link.href) window.open(link.href, '_blank');
      });
    }
  }
</script>

<style>
    /* --- Edit Mode Styles --- */
    
    /* 1. Container adjustments */
    .edit-mode-active .draggable-section {
        border-color: var(--color-primary-500) !important;
        border-style: dashed !important;
        border-width: 2px !important;
        background-color: var(--color-primary-50);
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        cursor: grab; 
    }
    .edit-mode-active .draggable-section:active {
        cursor: grabbing;
    }

    .dark .edit-mode-active .draggable-section {
        background-color: var(--color-primary-950);
    }

    /* 2. Link Styles */
    .edit-mode-active .draggable-link {
        border: 1px dashed var(--color-primary-300);
        cursor: grab;
    }
    .dark .edit-mode-active .draggable-link {
        border-color: var(--color-primary-700);
    }
    
    /* 3. Logic Helpers */
    .edit-mode-active .link-dot { opacity: 1 !important; transform: scale(1) !important; }
    .edit-mode-active .link-arrow { display: none !important; }
    .edit-mode-active .edit-mode-hidden { display: none !important; }
    .edit-mode-active .edit-mode-visible { display: flex !important; }
    .edit-mode-active .edit-mode-overlay { display: block !important; }
    .edit-mode-active .edit-mode-disable { pointer-events: none; }
    
    /* Hide the 'Add Link' text buttons during drag to reduce visual noise */
    body.dragging-active .static-add-btn { opacity: 0; pointer-events: none; }

    /* --- EXPAND DROP ZONES (FIXED) --- */
    
    /* 1. HIDE the entire button container wrapper when dragging links */
    /* Note: .group\/add escapes the slash in the class name "group/add" */
    body.dragging-link-active .group\/add {
        display: none !important;
    }
    
    /* 2. FORCE the section-links container to fill the remaining space */
    body.dragging-link-active .section-links {
        flex-grow: 1 !important;
        height: 100% !important; /* Force full available height */
        min-height: 0 !important; /* Allow shrinking if necessary, though flex-grow pushes it */
        background-color: rgba(0,0,0,0.02); /* Visual indicator */
        overflow-y: auto !important; /* Ensure scroll works if it truly overflows */
    }
    
    body.dragging-link-active.dark .section-links {
        background-color: rgba(255,255,255,0.02);
    }

    /* --- Dragging Physics & Visuals --- */

    /* Ghost */
    .sortable-ghost {
        opacity: 0.2 !important;
        background: var(--color-primary-200) !important;
        border: 2px dashed var(--color-primary-500) !important;
    }
    .dark .sortable-ghost {
        background: var(--color-primary-900) !important;
        border-color: var(--color-primary-500) !important;
        opacity: 0.3 !important;
    }

    /* Chosen */
    .sortable-drag {
        opacity: 1 !important;
        background: white; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: scale(1.02); 
    }
    .dark .sortable-drag {
        background: #1f2937; /* gray-800 */
    }
</style>
{% endblock %}